---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

const posts = (await getCollection('blog'))
	.filter(post => !post.data.isDraft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const title = "Yazılım ve Teknoloji Blogu";
const description = "Yazılım ve teknoloji üzerine rehberler, teknik içerikler, proje deneyimleri ve kişisel notlar. Dijital dünyaya dair düzenli paylaşımlar.";

const searchIndex = posts.map((post) => ({
	slug: post.slug,
	title: post.data.title,
	description: post.data.description,
	tags: post.data.tags ?? [],
	author: post.data.author ?? '',
	body: post.body ?? '',
}));
---

<BaseLayout title={title} description={description}>
	<section class="hero">
		<h1 class="hero-title">Merhaba, Ben Samet <span class="emoji">👋</span></h1>
		<p class="subtitle">Bu benim dijital bahçem. Burada teknoloji, yazılım ve kişisel deneyimlerimi paylaşıyorum.</p>
	</section>

	<section class="posts">
		<h2>Son Yazılar</h2>

		<div class="home-search-box">
			<label for="home-search" class="home-search-label">Ana sayfada hızlı ara</label>
			<div class="search-input-wrap">
				<span class="search-icon" aria-hidden="true">🔎</span>
				<input id="home-search" type="search" placeholder="Örn: astro, modernizasyon, hemera..." autocomplete="off" />
			</div>
			<p id="home-search-status" class="home-search-status">Toplam {posts.length} gönderi.</p>
			<a href="/blog" class="archive-link">Detaylı arama için tüm arşiv →</a>
		</div>

		<div class="posts-grid" id="home-posts-grid">
			{posts.map((post) => (
				<article class="post-card" data-post-slug={post.slug}>
					<a href={`/blog/${post.slug}/`}>
						<span class="date">{post.data.pubDate.toLocaleDateString('tr-TR', {
							year: 'numeric',
							month: 'long',
							day: 'numeric',
						})}</span>
						<h3 class="post-title">{post.data.title}</h3>
						<p class="post-desc">{post.data.description}</p>
						{post.data.tags && (
							<div class="tags">
								{post.data.tags.map(tag => (
									<span class="tag">#{tag}</span>
								))}
							</div>
						)}
						<span class="read-more">Devamını Oku →</span>
					</a>
				</article>
			))}
		</div>
		<div id="home-no-results" class="home-no-results" style="display:none;">Bu arama için sonuç bulunamadı.</div>
	</section>

	<script is:inline define:vars={{ searchIndex, totalPosts: posts.length }}>
		const charMap = {
			'ç': 'c', 'ğ': 'g', 'ı': 'i', 'İ': 'i', 'ö': 'o', 'ş': 's', 'ü': 'u'
		};

		function normalizeText(value) {
			return (value || '')
				.toLocaleLowerCase('tr-TR')
				.replace(/[çğıİöşü]/g, (ch) => charMap[ch] || ch)
				.replace(/\s+/g, ' ')
				.trim();
		}

		function tokenize(value) {
			return normalizeText(value)
				.split(/[^\p{L}\p{N}]+/u)
				.filter(Boolean);
		}

		const indexedPosts = searchIndex.map((post) => ({
			slug: post.slug,
			titleTokens: tokenize(post.title),
			tagTokens: tokenize((post.tags || []).join(' ')),
			descriptionTokens: tokenize(post.description),
			bodyTokens: tokenize(post.body),
			authorTokens: tokenize(post.author),
		}));

		const tokenMatch = (tokens, queryToken) => {
			if (tokens.includes(queryToken)) return true;
			if (queryToken.length >= 3) return tokens.some((t) => t.startsWith(queryToken));
			return false;
		};

		function scorePost(post, queryTokens) {
			let score = 0;
			for (const qt of queryTokens) {
				const inTitle = tokenMatch(post.titleTokens, qt);
				const inTags = tokenMatch(post.tagTokens, qt);
				const inDescription = tokenMatch(post.descriptionTokens, qt);
				const inBody = tokenMatch(post.bodyTokens, qt);
				const inAuthor = tokenMatch(post.authorTokens, qt);

				if (!(inTitle || inTags || inDescription || inBody || inAuthor)) return -1;

				if (inTitle) score += 5;
				if (inTags) score += 4;
				if (inDescription) score += 3;
				if (inAuthor) score += 2;
				if (inBody) score += 1;
			}
			return score;
		}

		function escapeRegex(value) {
			return value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
		}

		function initHomeSearch() {
			const searchInput = document.getElementById('home-search');
			const searchStatus = document.getElementById('home-search-status');
			const noResults = document.getElementById('home-no-results');
			const cards = Array.from(document.querySelectorAll('[data-post-slug]'));
			if (!searchInput || !searchStatus || !noResults || cards.length === 0) return;
			if (searchInput.dataset.searchBound === '1') return;
			searchInput.dataset.searchBound = '1';

			const highlightTargets = cards.map((card) => {
				const titleEl = card.querySelector('.post-title');
				const descEl = card.querySelector('.post-desc');
				const tagEls = Array.from(card.querySelectorAll('.tag'));

				if (titleEl && !titleEl.dataset.original) titleEl.dataset.original = titleEl.textContent || '';
				if (descEl && !descEl.dataset.original) descEl.dataset.original = descEl.textContent || '';
				tagEls.forEach((el) => {
					if (!el.dataset.original) el.dataset.original = el.textContent || '';
				});

				return { titleEl, descEl, tagEls };
			});

			function applyHighlight(el, queryTokens) {
				if (!el) return;
				const original = el.dataset.original || '';
				if (!queryTokens.length) {
					el.textContent = original;
					return;
				}

				const pattern = queryTokens.filter((t) => t.length >= 2).map(escapeRegex).join('|');
				if (!pattern) {
					el.textContent = original;
					return;
				}

				const re = new RegExp(`(${pattern})`, 'giu');
				el.innerHTML = original.replace(re, '<mark>$1</mark>');
			}

			function runSearch() {
				const query = searchInput.value || '';
				const normalizedQuery = normalizeText(query);

				if (normalizedQuery.length > 0 && normalizedQuery.length < 2) {
					cards.forEach((card) => (card.style.display = 'none'));
					highlightTargets.forEach(({ titleEl, descEl, tagEls }) => {
						applyHighlight(titleEl, []);
						applyHighlight(descEl, []);
						tagEls.forEach((tagEl) => applyHighlight(tagEl, []));
					});
					noResults.style.display = 'block';
					searchStatus.textContent = 'En az 2 karakter girerek arama yapabilirsin.';
					return;
				}

				if (!normalizedQuery) {
					cards.forEach((card) => (card.style.display = 'block'));
					highlightTargets.forEach(({ titleEl, descEl, tagEls }) => {
						applyHighlight(titleEl, []);
						applyHighlight(descEl, []);
						tagEls.forEach((tagEl) => applyHighlight(tagEl, []));
					});
					noResults.style.display = 'none';
					searchStatus.textContent = `Toplam ${totalPosts} gönderi.`;
					return;
				}

				const queryTokens = tokenize(normalizedQuery);
				const matches = indexedPosts
					.map((post) => ({ slug: post.slug, score: scorePost(post, queryTokens) }))
					.filter((item) => item.score >= 0)
					.sort((a, b) => b.score - a.score);

				const visible = new Set(matches.map((m) => m.slug));
				cards.forEach((card) => {
					const slug = card.getAttribute('data-post-slug');
					card.style.display = slug && visible.has(slug) ? 'block' : 'none';
				});

				highlightTargets.forEach(({ titleEl, descEl, tagEls }, index) => {
					const slug = cards[index]?.getAttribute('data-post-slug');
					const shouldHighlight = slug && visible.has(slug);
					const tokens = shouldHighlight ? queryTokens : [];
					applyHighlight(titleEl, tokens);
					applyHighlight(descEl, tokens);
					tagEls.forEach((tagEl) => applyHighlight(tagEl, tokens));
				});

				noResults.style.display = matches.length === 0 ? 'block' : 'none';
				searchStatus.textContent = `"${query}" için ${matches.length} sonuç bulundu. (ESC ile temizle)`;
			}

			searchInput.addEventListener('input', runSearch);
			searchInput.addEventListener('keydown', (event) => {
				if (event.key === 'Escape') {
					searchInput.value = '';
					runSearch();
				}
			});
		}

		initHomeSearch();
		document.addEventListener('astro:page-load', initHomeSearch);
	</script>

	<style>
		.hero {
			padding: 6rem 0;
			text-align: center;
		}

		h1 {
			font-size: 3.5rem;
			margin-bottom: 1.5rem;
			background: linear-gradient(to right, var(--accent), #818cf8);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		.subtitle {
			font-size: 1.25rem;
			color: var(--secondary);
			max-width: 600px;
			margin: 0 auto;
		}

		.posts {
			margin-top: 4rem;
		}

		h2 {
			font-size: 1rem;
			margin-bottom: 1.25rem;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: var(--secondary);
			text-align: center;
		}

		.home-search-box {
			margin-bottom: 2rem;
			padding: 1rem;
			background: var(--card-bg);
			border: 1px solid var(--border);
			border-radius: 1rem;
			box-shadow: var(--shadow);
		}

		.home-search-label {
			display: block;
			font-weight: 600;
			margin-bottom: 0.5rem;
		}

		.search-input-wrap {
			position: relative;
		}

		.search-icon {
			position: absolute;
			left: 0.75rem;
			top: 50%;
			transform: translateY(-50%);
			opacity: 0.7;
			pointer-events: none;
		}

		#home-search {
			width: 100%;
			padding: 0.75rem 0.9rem 0.75rem 2.2rem;
			border-radius: 0.75rem;
			border: 1px solid var(--border);
			background: var(--bg);
			color: var(--text);
			font: inherit;
		}

		#home-search:focus {
			outline: 2px solid var(--accent);
			outline-offset: 1px;
		}

		.home-search-status {
			margin-top: 0.6rem;
			color: var(--secondary);
			font-size: 0.92rem;
			margin-bottom: 0.35rem;
		}

		.archive-link {
			font-size: 0.92rem;
			font-weight: 600;
		}

		.home-no-results {
			margin-top: 1rem;
			padding: 1rem;
			border: 1px dashed var(--border);
			border-radius: 0.75rem;
			background: var(--card-bg);
			color: var(--secondary);
			text-align: center;
		}

		.posts-grid {
			display: grid;
			grid-template-columns: 1fr;
			gap: 2rem;
		}

		.post-card {
			background: var(--card-bg);
			border: 1px solid var(--border);
			border-radius: 1.5rem;
			transition: all 0.3s ease;
			box-shadow: var(--shadow);
			overflow: hidden;
		}

		.post-card:hover {
			transform: translateY(-5px);
			border-color: var(--accent);
			box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
		}

		.post-card a {
			padding: 2.5rem;
			text-decoration: none;
			color: inherit;
			display: block;
		}

		.date {
			font-size: 0.875rem;
			color: var(--secondary);
			display: block;
			margin-bottom: 1rem;
			font-weight: 500;
		}

		.post-title {
			font-size: 1.75rem;
			margin-bottom: 1rem;
			font-weight: 800;
			line-height: 1.2;
		}

		.post-desc {
			color: var(--secondary);
			font-size: 1.1rem;
			margin-bottom: 1.5rem;
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}

		.tags {
			display: flex;
			flex-wrap: wrap;
			gap: 0.5rem;
			margin-bottom: 1.5rem;
		}

		.tag {
			background: var(--accent-light);
			color: var(--accent);
			font-size: 0.8rem;
			font-weight: 600;
			padding: 0.25rem 0.75rem;
			border-radius: 2rem;
			text-transform: lowercase;
			border: 1px solid transparent;
			transition: all 0.2s ease;
		}

		.post-card:hover .tag {
			border-color: var(--accent);
			background: var(--card-bg);
		}

		.read-more {
			font-weight: 600;
			color: var(--accent);
			font-size: 0.95rem;
		}

		mark {
			background: color-mix(in srgb, var(--accent) 28%, transparent);
			color: inherit;
			padding: 0 0.15rem;
			border-radius: 0.25rem;
		}
	</style>
</BaseLayout>


